{% extends "quotes/base.html" %}
{% block title %}–ú–æ–¥–µ—Ä–∞—Ü–∏—è ‚Äî –û—á–µ—Ä–µ–¥—å{% endblock %}

{% block content %}
  <h2>–¶–∏—Ç–∞—Ç—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h2>

  {% for q, form in queue_items %}
    <div class="card" style="margin-bottom:.75rem;">
      <div style="font-size:1.05rem;">‚Äú{{ q.text }}‚Äù</div>
      <div class="muted">
        –ò—Å—Ç–æ—á–Ω–∏–∫: {{ q.source.name }} ‚Ä¢ –í–µ—Å: {{ q.weight }} ‚Ä¢ –ê–≤—Ç–æ—Ä: {{ q.author.username }} ‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–∞: {{ q.created_at|date:"d.m.Y H:i" }}
      </div>

      <form method="post" action="{% url 'quotes:moderation_quote_approve' q.pk %}" style="margin-top:.5rem;">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div style="margin-bottom:.5rem;">
          {{ form.weight.label_tag }} {{ form.weight }}
          {% if form.weight.errors %}
            <div class="errorlist">{{ form.weight.errors }}</div>
          {% endif %}
        </div>

        <div style="margin-bottom:.5rem;">
          {{ form.tags.label_tag }} {{ form.tags }}
          {% if form.tags.errors %}
            <div class="errorlist">{{ form.tags.errors }}</div>
          {% endif %}
        </div>

        <button type="submit">‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </form>

      <form method="post" action="{% url 'quotes:moderation_quote_reject' q.pk %}" style="margin-top:.5rem;">
        {% csrf_token %}
        <input name="reason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
        <button type="submit">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      </form>
    </div>
  {% empty %}
    <p>–ù–µ—Ç —Ü–∏—Ç–∞—Ç –≤ –æ—á–µ—Ä–µ–¥–∏.</p>
  {% endfor %}

<h2 style="margin-top:1.25rem;">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏</h2>
{% for s in sources %}
  <div class="card" style="margin-bottom:.75rem;">
    <div>{{ s.name }}</div>
    <div class="muted">
      –°–æ–∑–¥–∞–Ω: {{ s.created_at|date:"d.m.Y H:i" }} ‚Ä¢ –°—Ç–∞—Ç—É—Å: {{ s.get_status_display }}
    </div>

    <form method="post" action="{% url 'quotes:moderation_source_approve' s.pk %}" class="inline">
      {% csrf_token %}
      <button type="submit">‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </form>

    <form method="post" action="{% url 'quotes:moderation_source_reject' s.pk %}" class="inline">
      {% csrf_token %}
      <button type="submit">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </form>

    {# –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –ü–û –ù–ê–ó–í–ê–ù–ò–Æ #}
    <form method="post" action="{% url 'quotes:moderation_source_merge' s.pk %}" class="inline" style="margin-left:.25rem;">
      {% csrf_token %}
      <input name="target_name"
             list="sources-list"
             placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞"
             style="width:260px;"
             required />
      <button type="submit">üîÄ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å</button>
    </form>
  </div>
{% empty %}
  <p>–ù–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏.</p>
{% endfor %}

{# —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –¥–ª—è –ø–æ–ª—è target_name #}
<datalist id="sources-list">
  {% for it in all_sources %}
    <option value="{{ it.name }}"></option>
  {% endfor %}
</datalist>

  <h2 style="margin-top:1.25rem;">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</h2>
  <form method="post" action="{% url 'quotes:add_tag' %}">
    {% csrf_token %}
    <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞" style="width:240px;" />
    <button type="submit">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
  </form>

  {# –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –æ—à–∏–±–æ–∫ #}
  <style>
    .errorlist { color: #b30000; margin-top: .25rem; }
  </style>
{% endblock %}

<script>
document.querySelectorAll("form").forEach(form => {
  form.addEventListener("submit", function(event) {
    const checkboxes = form.querySelectorAll("input[type=checkbox][name=tags]");
    const isChecked = Array.from(checkboxes).some(cb => cb.checked);
    if (!isChecked) {
      alert("–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ–≥!");
      event.preventDefault();
    }
  });
});
</script>
